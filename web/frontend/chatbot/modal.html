<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot — GetGreen </title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="modal.css">
</head>
<body>
  
  <div id="modalOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="close" id="closeModal" aria-label="Fechar">×</button>
      <h2 id="modalTitle">Chatbot GetGreen</h2>

      <div id="chatContainer" class="chat-container">
        <div id="chatArea" class="chat-area" aria-live="polite"></div>

        <div id="optionsContainer" class="options"></div>

        <div class="inputRow">
          <input id="manualInput" placeholder="Enviar mensagem (opcional)" autocomplete="off" />
          <button id="sendManual" class="submit-btn" style="width:120px;margin-left:8px">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    const open = document.getElementById('openModal');
    const overlay = document.getElementById('modalOverlay');
    const close = document.getElementById('closeModal');
    const form = document.getElementById('coletaForm');

    function showModal() {
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      // focus first input
      const first = form.querySelector('input[name="responsavel"]');
      if (first) first.focus();
    }
    function hideModal() {
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
    }

    open.addEventListener('click', (e) => { e.preventDefault(); showModal(); });
    close.addEventListener('click', hideModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) hideModal(); });

    try {
      const params = new URLSearchParams(window.location.search);
      if (params.get('open') === '1') showModal();
    } catch (e) { }

      const WS_URL = 'ws://localhost:8080';
      let ws = null;
      let reconnectTimer = null;

      const chatArea = document.getElementById('chatArea');
      const opts = document.getElementById('optionsContainer');
      const manualInput = document.getElementById('manualInput');
      const sendManual = document.getElementById('sendManual');

      function appendMessage(text, who) {
        const el = document.createElement('div');
        el.className = 'msg ' + (who === 'user' ? 'user' : 'server');
        el.textContent = text;
        chatArea.appendChild(el);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function connectWS() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
        ws = new WebSocket(WS_URL);
        ws.addEventListener('open', () => {
          appendMessage('Conectado ao adaptador.', 'user');
        });

        ws.addEventListener('message', (evt) => {
          let obj = null;
          try { obj = JSON.parse(evt.data); } catch (e) { console.warn('Invalid adapter message', evt.data); return; }
          if (obj.type === 'RESP' || obj.type === 'MSG') {
            const text = obj.payload || '';
            if (text.toLowerCase().includes('bem-vindo') || text.toLowerCase().includes('0 - sair')) {
              renderOptions(text);
              appendMessage('Menu recebido.', 'user');
            } else {
              appendMessage(text, 'server');
            }
          } else if (obj.type === 'DES') {
            appendMessage('Servidor está desligando.', 'server');
          } else if (obj.type === 'ERROR') {
            appendMessage('Erro: ' + obj.payload, 'server');
          }
        });

        ws.addEventListener('close', () => {
          appendMessage('Conexão com adaptador fechada.', 'user');
          // try reconnect later
          if (!reconnectTimer) reconnectTimer = setTimeout(() => { reconnectTimer = null; connectWS(); }, 2000);
        });

        ws.addEventListener('error', (e) => {
          console.error('WS error', e);
        });
      }

      function renderOptions(menuText) {
        opts.innerHTML = '';
        const lines = menuText.split('\n');
        for (const line of lines) {
          const m = line.match(/^\s*(\d+)\s*-\s*(.+)$/);
          if (m) {
            const btn = document.createElement('button');
            btn.textContent = m[1] + ' — ' + m[2];
            btn.className = 'option-btn';
            btn.addEventListener('click', () => {
              if (!ws || ws.readyState !== WebSocket.OPEN) { appendMessage('Adaptador indisponível', 'user'); return; }
              ws.send(JSON.stringify({ type: 'PED', payload: m[1] }));
              appendMessage('Você: ' + m[2], 'user');
            });
            opts.appendChild(btn);
          }
        }
      }

      sendManual.addEventListener('click', () => {
        const txt = manualInput.value.trim();
        if (!txt) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) { appendMessage('Adaptador indisponível', 'user'); return; }
        
        ws.send(JSON.stringify({ type: 'RESP', payload: txt }));
        appendMessage('Você: ' + txt, 'user');
        manualInput.value = '';
      });

      // inicializa
      connectWS();

      // Inicia escondido
      hideModal();
  </script>
</body>
</html>
