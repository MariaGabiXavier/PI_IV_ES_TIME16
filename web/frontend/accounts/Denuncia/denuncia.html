<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GetGreen - Realizar Denúncia</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Jomolhari&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/web/frontend/accounts/Denuncia/denuncia.css"> 
  <link rel="stylesheet" href="../../chatbot/modal.css">
</head>
<body>

  <div class="dashboard-container">

    <aside class="dashboard-sidebar">
      <a href="/web/frontend/accounts/PrincipalGetGreen/principalColaborador.html" class="logo-getgreen">GetGreen</a>

      <nav class="sidebar-nav">
        <h4>Perfil</h4>
        <ul>
            <li><a href="/web/frontend/accounts/Perfil/Perfil.html"><span class="material-icons-outlined">person</span>visualizar perfil</a></li>
            <li><a href="#"><span class="material-icons-outlined">edit</span>editar perfil</a></li>
            <li><a href="#"><span class="material-icons-outlined">home</span>editar endereço</a></li>
            <li><a href="#"><span class="material-icons-outlined">add_location</span>adicionar novo endereço</a></li>
        </ul>

        <h4>Minhas atividades</h4>
        
        <ul id="menuAtividadesColaborador">
        </ul>
        
        <ul>
            <li><a href="/web/frontend/accounts/feedback/feedback.html"><span class="material-icons-outlined">feedback</span>visualizar feedbacks</a></li>
            <li><a href="/web/frontend/accounts/Denuncia/denuncia.html"><span class="material-icons-outlined">report</span>realizar denúncia</a></li>
            <li><a href="#" id="openChatbot"><span class="material-icons-outlined">support_agent</span>solicitar suporte</a></li> 
            <li><a href="#" id="logoutLinkFeedback"><span class="material-icons-outlined">logout</span>sair da conta</a></li>
        </ul>
        
      </nav>
        
      </nav>
    </aside>

    <main class="dashboard-main">
      <header class="dashboard-header">
        <nav class="main-nav">
          <a href="#" id="homeLink">Home</a> 
        </nav>
        <a href="#" class="user-profile">
          <span class="material-icons-outlined">account_circle</span>
          <span id="usuarioNome">Usuário</span>
        </a>
      </header>

      <section class="denuncia-section">
        <div class="title-row"> 
            <h1>Realizar Denúncia</h1>
        </div>
        
        <p>Use este formulário para relatar problemas relacionados à coleta, descumprimentos ou comportamentos inadequados.</p>

        <form id="formDenuncia" class="denuncia-form">
          <div class="form-row">
            <label for="titulo">Título da denúncia</label>
            <input type="text" id="titulo" name="titulo" placeholder="Ex: Falta de coleta agendada" required>
          </div>

          <div class="form-row">
            <label for="descricao">Descrição detalhada</label>
            <textarea id="descricao" name="descricao" rows="4" placeholder="Descreva o ocorrido..." required></textarea>
          </div>

          <div class="form-row">
            <label for="local">Local do ocorrido</label>
            <input type="text" id="local" name="local" placeholder="Ex: Rua das Flores, 120 - Paulínia">
          </div>

          <div class="form-row">
            <label for="dataOcorrencia">Data do ocorrido</label>
            <input type="date" id="dataOcorrencia" name="dataOcorrencia" required>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit-nova-coleta">enviar denúncia</button> 
          </div>
        </form>
      </section>

      <div id="modalOverlay" class="overlay" aria-hidden="true" style="display:none;">
          <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
              <button class="close" id="closeModal" aria-label="Fechar">×</button>
              <h2 id="modalTitle">Chatbot GetGreen</h2>

              <div id="chatContainer" class="chat-container">
                  <div id="chatArea" class="chat-area" aria-live="polite"></div>

                  <div id="optionsContainer" class="options"></div>

                  <div class="inputRow">
                      <input id="manualInput" placeholder="Enviar mensagem (opcional)" autocomplete="off" />
                      <button id="sendManual" class="submit-btn" style="width:120px;margin-left:8px">Enviar</button>
                  </div>
              </div>
          </div>
      </div>
      </main>
  </div>

  <script>
    const nome = sessionStorage.getItem('usuarioNome');
    const tipo = sessionStorage.getItem('usuarioTipo'); 
    const idLogado = sessionStorage.getItem('usuarioId'); 
    
    const homeLink = document.getElementById('homeLink');
    const logoutLinkFeedback = document.getElementById('logoutLinkFeedback');
    const form = document.getElementById('formDenuncia');

    const usuarioNomeElement = document.getElementById('usuarioNome');
    const menuAtividadesColaborador = document.getElementById('menuAtividadesColaborador');

    usuarioNomeElement.textContent = nome || 'Usuário';

    if (tipo === 'colaborador') {
        menuAtividadesColaborador.innerHTML = `
            <li><a href="/web/frontend/accounts/MinhasColetasColaborador/ColetasColaborador.html"><span class="material-icons-outlined">recycling</span>minhas coletas</a></li>
        `;
        if(homeLink) homeLink.href = "/web/frontend/accounts/PrincipalGetGreen/principalColaborador.html";
    } else if (tipo === 'empresa') {
        menuAtividadesColaborador.innerHTML = '';
        if(homeLink) homeLink.href = "/web/frontend/accounts/PrincipalGetGreen/principalEmpresas.html";
    }


    homeLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (tipo === 'empresa') {
            window.location.href = "/web/frontend/accounts/PrincipalGetGreen/principalEmpresas.html";
        } else if (tipo === 'colaborador') {
            window.location.href = "/web/frontend/accounts/PrincipalGetGreen/principalColaborador.html";
        } else {
            window.location.href = "/web/frontend/accounts/IndexGetGreen/index.html";
        }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!idLogado) {
           alert('Erro de autenticação: ID de usuário não encontrado.');
           return; 
      }

      const data = {
        titulo: form.titulo.value.trim(),
        descricao: form.descricao.value.trim(),
        local: form.local.value.trim(),
        dataOcorrencia: form.dataOcorrencia.value,
        usuarioId: idLogado,
        usuarioNome: nome,
      };

      try {
        const response = await fetch('http://localhost:4000/api/denuncias', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const resultado = await response.json();

        if (response.ok) {
          alert('Denúncia enviada com sucesso!');
          form.reset();
        } else {
          alert('Erro ao enviar denúncia: ' + resultado.error);
        }
      } catch (err) {
        alert('Erro de conexão com o servidor.');
        console.error(err);
      }
    });
    
    function logout() {
        sessionStorage.removeItem('usuarioNome');
        sessionStorage.removeItem('usuarioTipo');
        sessionStorage.removeItem('usuarioId'); 
        window.location.href = "/web/frontend/accounts/IndexGetGreen/index.html"; 
    }
    if (logoutLinkFeedback) {
        logoutLinkFeedback.addEventListener('click', (e) => {
            e.preventDefault(); 
            if (confirm('Tem certeza que deseja sair da conta?')) {
                logout();
            }
        });
    }

    const btnChat = document.getElementById('openChatbot');
    const overlayChat = document.getElementById('modalOverlay');
    const closeChat = document.getElementById('closeModal');
    const chatArea = document.getElementById('chatArea');
    const opts = document.getElementById('optionsContainer');
    const manualInput = document.getElementById('manualInput');
    const sendManual = document.getElementById('sendManual');

    function showModalChat() {
        overlayChat.style.display = 'flex';
        overlayChat.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
    }
    function hideModalChat(){
        overlayChat.style.display = 'none';
        overlayChat.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
    }

    if (btnChat) btnChat.addEventListener('click', function(e){ e.preventDefault(); showModalChat(); });
    if (closeChat) closeChat.addEventListener('click', hideModalChat);
    if (overlayChat) overlayChat.addEventListener('click', function(e){ if (e.target === overlayChat) hideModalChat(); });

    const WS_URL = 'ws://localhost:8080';
    let ws = null;
    let reconnectTimer = null;

    function appendMessage(text, who) {
        const el = document.createElement('div');
        el.className = 'msg ' + (who === 'user' ? 'user' : 'server');
        el.textContent = text;
        chatArea.appendChild(el);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function connectWS() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
        ws = new WebSocket(WS_URL);
        ws.addEventListener('open', () => { appendMessage('Conectado ao adaptador.', 'user'); });
        ws.addEventListener('message', (evt) => {
            let obj = null; try { obj = JSON.parse(evt.data); } catch (e) { return; }
            if (obj.type === 'RESP' || obj.type === 'MSG') {
                const text = obj.payload || '';
                if (text.toLowerCase().includes('bem-vindo') || text.toLowerCase().includes('0 - sair')) { renderOptions(text); }
                else appendMessage(text, 'server');
            } else if (obj.type === 'DES') appendMessage('Servidor está desligando.', 'server');
            else if (obj.type === 'ERROR') appendMessage('Erro: ' + obj.payload, 'server');
        });
        ws.addEventListener('close', () => { appendMessage('Conexão com adaptador fechada.', 'user'); if (!reconnectTimer) reconnectTimer = setTimeout(()=>{ reconnectTimer=null; connectWS(); },2000); });
        ws.addEventListener('error', (e)=>{ console.error('WS error', e); });
    }

    function renderOptions(menuText){
        opts.innerHTML = ''; const lines = menuText.split('\n');
        for (const line of lines){ const m = line.match(/^\s*(\d+)\s*-\s*(.+)$/); if (m){ const btn = document.createElement('button'); btn.textContent = m[1] + ' — ' + m[2]; btn.className='option-btn'; btn.addEventListener('click', ()=>{ if (!ws||ws.readyState!==WebSocket.OPEN){ appendMessage('Adaptador indisponível','user'); return; } ws.send(JSON.stringify({type:'PED', payload: m[1]})); appendMessage('Você: '+m[2],'user'); }); opts.appendChild(btn);} }
    }

    sendManual.addEventListener('click', ()=>{ 
        const txt = manualInput.value.trim(); 
        if (!txt) return; 

        appendMessage('Você: ' + txt, 'user');
        appendMessage(
            'No momento, só posso responder perguntas do menu. ' +
            'Caso queira fazer outra pergunta, entre em contato nas redes sociais e email.',
            'server'
        );
        manualInput.value = '';
    });

    let connectedOnce = false;
    if (btnChat) btnChat.addEventListener('click', ()=>{ if(!connectedOnce){ connectWS(); connectedOnce=true; } });
  </script>
</body>
</html>